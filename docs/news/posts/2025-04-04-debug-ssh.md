---
blogpost: true
category: Blog
tags: SSH, <add-more-tags-here>
author: Virginie de Mestral
date: 2025-04-04
---

# How to debug your failing ssh connection to a remote computer (and bring peace back to the land of aiida)

## The exposition
I configured a new remote host in the land of aiida lately. This host is a supercomputer called alps. Although alps is known to be quite powerful, it is also very fond of security. It charges every user who demands its services to validate their ssh key every 24h. Unfortunately, if a user's job lasts longer than a day, the user has to re-validate his key and, if needed, re-play his job. Re-playing a job usually goes smoothly - past information is preserved and passed on to the next calculation. However, it can happen that the key revalidation process fails, in spite of following exactly the same procedure than for the initial key validation. In such cases, the initial calculation is indefinitely put on hold.

## The rising action
I validated my key to access alps the other day and sent a routine job. Everything was working fine until the 24h expired. I then re-validated my key - buisness as usual, but it had become impossible to reconnect to alps. The `verdi computer test alps` prompted the following message:
```
Error: paramiko.ssh_exception.SSHException: key cannot be used for signing
Error:
Error: Error connecting to 'daint.alps.cscs.ch' through SSH: [SshTransport] No existing session, connect_args were: {'username': 'iam', 'port': 22, 'look_for_keys': True, 'key_filename': '', 'timeout': 60, 'allow_agent': True, 'proxy_jump': '', 'proxy_command': 'ssh -i ~/.ssh/cscs-key iam@ela.cscs.ch /usr/bin/netcat daint.alps.cscs.ch 22', 'compress': True, 'gss_auth': False, 'gss_kex': False, 'gss_deleg_creds': False, 'gss_host': 'daint.alps.cscs.ch'}
[FAILED]: Error while trying to connect to the computer
```
Apparently, aiida could not find the right key upon re-validation anymore.

## The climax
Not knowing the exact origin of the problem, one evident attempt was to explicitely tell aiida where to find the one and only key. It might have been looking for the right key among others (yes I have a conservative tendency to accumulate ssh keys) and picked the wrong one (no offense aiida, everybody can make mistakes). In practice, I needed to make sure that the computer configuration describes the full path to the ssh key, and instead of the `SSH proxy command` give the `SSH proxy jump` computer address. Also, I set the `Allow ssh agent` and the `Look for keys` to False.
```
$ verdi computer configure core.ssh alps
Report: enter ? for help.
Report: enter ! to ignore the default and set no value.
User name [iam]:
Port number [22]:
Look for keys [Y/n]: n
SSH key file [/user/.ssh/key]: /home/iam/.ssh/cscs-key
Connection timeout in s [60]:
Allow ssh agent [Y/n]: n
SSH proxy jump []: ela.cscs.ch
SSH proxy command []:
Compress file transfers [Y/n]:
GSS auth [False]:
GSS kex [False]:
GSS deleg_creds [False]:
GSS host [daint.alps.cscs.ch]:
Load system host keys [Y/n]:
Key policy (RejectPolicy, WarningPolicy, AutoAddPolicy) [RejectPolicy]:
Use login shell when executing command [Y/n]:
Connection cooldown time (s) [30.0]:
Report: Configuring computer daint.alps for user aiida@localhost.
Success: alps successfully configured for aiida@localhost
```
This time, the `verdi computer test alps` confirmed that the remote host alps was successfully configured.

## The falling action
We shall not shout victory too soon... Thanks to the reconfiguration of the remote host, I could send jobs to alps and retrieve calculations after completion. However, I still could not access individual jobs while they were running:
```
(aiida) [iam@local ~/.aiida]$ verdi calcjob gotocomputer <pk>
Report: going to the remote work directory...
iam@ela.cscs.ch: Permission denied (publickey).
kex_exchange_identification: Connection closed by remote host
```
The error message issued by aiida was very strange. I was able to ssh into alps via the proxy ela outside of aiida without any problem, but doing so within the aiida machinery informed me that I was denied permission.

## The resolution
In fact, the `gotocomputer` command calls regular ssh protocol, which is defined in the ~/.ssh/config file. Mine read:
```
Host ela
  Hostname ela.cscs.ch
  User vdemestr
  IdentityFile ~/.ssh/cscs-key

Host alps
  Hostname daint.alps.cscs.ch
  User vdemestr
  Proxyjump ela
  Forwardagent yes
  IdentityFile ~/.ssh/cscs-key
  AddKeysToAgent yes
```
Which was confusing to aiida. Instead, the ela host should be explicitely designated as `ela.cscs.ch` in the header, and the alps proxyjump variable should read `ela.cscs.ch`:
```
Host ela, ela.cscs.ch
  Hostname ela.cscs.ch
  User vdemestr
  IdentityFile ~/.ssh/cscs-key

Host alps
  Hostname daint.alps.cscs.ch
  User vdemestr
  Proxyjump ela.cscs.ch
  Forwardagent yes
  IdentityFile ~/.ssh/cscs-key
  AddKeysToAgent yes
```

## The denouement
Since then, jobs run smoothly on alps, and can be regularly checked while running using the `verdi calcjob gotocomputer <pk>` command. Peace has returned to the land of aiida.
