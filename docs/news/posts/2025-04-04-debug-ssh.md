---
blogpost: true
category: Blog
tags: SSH, debug
author: Virginie de Mestral
date: 2025-04-04
---

# Fixing a failing SSH connection to a remote computer

Today's blog post brings you a user story about how a hard-to-fix failure in the SSH communication of AiiDA with a remote HPC machine could be resolved.
We hope you'll find it useful!

## The exposition

Recently, I configured a new remote host in the land of AiiDA, a supercomputer going by the name of [Alps](https://www.cscs.ch/computers/alps).
While Alps is quite powerful, it is also very fond of security.
Thus, it requires every user who demands its services to validate their SSH key every 24 hours.
Unfortunately, if a user's job lasts longer than those 24 hours, he/she have to re-validate their key and, if needed, re-`play` their simulation job[^1].
Thanks to AiiDA's provenance tracking and checkpointing, re-playing a job usually goes smoothly—past information is preserved and passed on to the next calculation.
However, it can happen that the key re-validation process fails, in which case, the initial calculation is put on hold indefinitely.
This can occur (and did so for me), in spite of following exactly the same procedure for key validation as before.

## The rising action

I validated my key to access Alps the other day and sent a routine job.
Everything was working fine until the next 24 hours had passed.
After another re-validation of my key (business as usual), it suddenly had become impossible to reconnect to Alps.
The `verdi computer test alps` command prompted the following message:

```
Error: paramiko.ssh_exception.SSHException: key cannot be used for signing
Error:
Error: Error connecting to 'daint.alps.cscs.ch' through SSH: [SshTransport] No existing session, connect_args were: {'username': 'iam', 'port': 22, 'look_for_keys': True, 'key_filename': '', 'timeout': 60, 'allow_agent': True, 'proxy_jump': '', 'proxy_command': 'ssh -i ~/.ssh/cscs-key iam@ela.cscs.ch /usr/bin/netcat daint.alps.cscs.ch 22', 'compress': True, 'gss_auth': False, 'gss_kex': False, 'gss_deleg_creds': False, 'gss_host': 'daint.alps.cscs.ch'}
[FAILED]: Error while trying to connect to the computer
```

Apparently, AiiDA could not find the right key anymore.

## The climax

Not knowing the exact origin of the problem, one evident attempt was to explicitly tell AiiDA where to find the key.
It might have been looking for the one among many (yes, I have a conservative tendency to accumulate SSH keys) and picked the wrong one (no offense AiiDA, everybody can make mistakes).
I therefore re-configured the SSH setup for my computer using `verdi computer configure core.ssh alps`, setting the `Look for keys` option to False, and instead explicitly provided the absolute path to my `SSH key file`[^2]:

```
$ verdi computer configure core.ssh alps
Report: enter ? for help.
Report: enter ! to ignore the default and set no value.
User name [iam]:
Port number [22]:
Look for keys [Y/n]: n
SSH key file [/user/.ssh/key]: /home/iam/.ssh/cscs-key
Connection timeout in s [60]:
Allow ssh agent [Y/n]: n
SSH proxy jump []: ela.cscs.ch
SSH proxy command []:
Compress file transfers [Y/n]:
GSS auth [False]:
GSS kex [False]:
GSS deleg_creds [False]:
GSS host [daint.alps.cscs.ch]:
Load system host keys [Y/n]:
Key policy (RejectPolicy, WarningPolicy, AutoAddPolicy) [RejectPolicy]:
Use login shell when executing command [Y/n]:
Connection cooldown time (s) [30.0]:
Report: Configuring computer daint.alps for user aiida@localhost.
Success: alps successfully configured for aiida@localhost
```

This time, `verdi computer test alps` confirmed that the remote host Alps was successfully configured[^3].

## The falling action

Thanks to the reconfiguration of the remote host, I could send jobs to Alps and retrieve calculations after completion.
So, problem solved?! Not quite—we shall not shout victory too soon.
As it turned out, I still could not access individual jobs while they were running using the handy `gotocomputer` command:

```
(aiida) [iam@local ~/.aiida]$ verdi calcjob gotocomputer <pk>
Report: going to the remote work directory...
iam@ela.cscs.ch: Permission denied (publickey).
kex_exchange_identification: Connection closed by remote host
```

This is despite being able to SSH into Alps outside of AiiDA via the proxy `ela` without any problem.
But when doing so using `verdi calcjob gotocomputer`, I was denied permission.

## The resolution

The issue can be understood with the fact that the `gotocomputer` command calls the regular SSH protocol of the OS, for which configuration is typically given in the `~/.ssh/config` file.
Mine read:

```
Host ela
  Hostname ela.cscs.ch
  User <my-user>
  IdentityFile ~/.ssh/cscs-key

Host alps
  Hostname daint.alps.cscs.ch
  User <my-user>
  Proxyjump ela
  Forwardagent yes
  IdentityFile ~/.ssh/cscs-key
  AddKeysToAgent yes
```

However, the actual SSH command constructed by AiiDA when calling `verdi calcjob gotocomputer` uses the value of the `SSH Proxy jump` setting to construct the final `ssh` command[^4].
Can you spot the difference?
`ela.cscs.ch` for the `SSH Proxy jump`, but `Host ela` in my `~/.ssh/config`.

Finally, this issue could be fixed by explicitely designating also the `Host ela.cscs.ch` in the header (SSH allows a list of `Host`s):

```
Host ela, ela.cscs.ch
  Hostname ela.cscs.ch
  User <my-user>
  IdentityFile ~/.ssh/cscs-key

Host alps
  Hostname daint.alps.cscs.ch
  User <my-user>
  Proxyjump ela.cscs.ch
  Forwardagent yes
  IdentityFile ~/.ssh/cscs-key
  AddKeysToAgent yes
```

## The denouement

Since then, jobs run smoothly on Alps, **and** can be regularly checked while running using `verdi calcjob gotocomputer <pk>`.
Peace has returned to the land of AiiDA.

## Afterword (by the devs)

In sumarry, the following two problems occurred:

1. Due to changes in the local configuration of SSH keys, the correct one could not be identified automatically by AiiDA (using `paramiko`), which broke all communication of AiiDA with the HPC &rarr; This could be fixed by manually passing the correct absolute path to the key file
2. A discrepancy between the host that was defined in the `~/.ssh/config` file (`ela`) and the host defined for the `ProxyJump` in AiiDA's computer configuration (`ela.cscs.ch`) led to a failure of the `gotocomputer` command &rarr; This could be fixed by modifying the `~/.ssh/config` file accordingly

The occurrence of both issues in succession made this problem tricky to solve.
We hope this story can be helpful if you ever find yourself encountering failure in the communication of AiiDA with a remote machine via SSH.

Lastly, we would like to provide some additional technical background information on this topic for the interested reader:
In AiiDA, the entity responsible for communication with the remote machine via SSH is the `SshTransport` plugin
(`src` [here](https://github.com/aiidateam/aiida-core/blob/660fec70ef43a64be7edae3c12f0a0fd5ef84349/src/aiida/transports/plugins/ssh.py#L65)).
It follows the general `Transport` interface, and uses the [`paramiko` library](https://github.com/paramiko/paramiko) SSH library.
Hence, AiiDA's SSH communication with a remote machine can differ from OS level `ssh` calls, leading to discrepancies.
As further explained in the blog post, the `verdi calcjob gotocomputer` command is somewhat of an odd one out, as it executes an OS `ssh` call, but uses configuration options from the AiiDA setup, rather than the `~/.ssh/config` file.
This showcases well the problem of having more than one possible sources of truth.

To solve the issue, we added an `SshAutoTransport` plugin to the code base, which automatically parses the `~/.ssh/config` file and sets the relevant options in AiiDA.
This not only reduces the effort for the user while configuring a `Computer`, but it also reduces the number of possible errrors.
For further reading, you can find
the original Discourse post that lead to this blog story
[here](https://aiida.discourse.group/t/disconnection-from-remote-machine-permission-denied/583),
AiiDA's general documentation on setting up remote connections
[here](https://aiida.readthedocs.io/projects/aiida-core/en/stable/howto/ssh.html),
the PR that added the `SshAutoTransport` plugin
[here](https://github.com/aiidateam/aiida-core/pull/6154/),
and, lastly, the PR that added the `AsyncSshTransport` plugin
[here](https://github.com/aiidateam/aiida-core/pull/6626).

... add notes on `AsyncSsh`, end points for both, and mention they will be in 2.7 release...

**Footnotes**

[^1]: `play` meaning re-submit a paused job, in AiiDA jargon.
[^2]: Automatic key resolution is done by `paramiko`, the SSH library AiiDA's `transport` interface uses. So this is somewhat out of AiiDA's control.
[^3]: There are other notable changes from my initial configuration that I applied for debugging the SSH connection via `verdi computer configure core.ssh alps`:
  For one, I set the `Allow ssh agent` option to False.
  The `ssh-agent` is a Linux tool that helps dealing with passphrase-protected keys, in particular, keeping private keys in memory after unlocking with the passphrase.
  As the SSH keys for Alps are, with a 24-hour lifetime, short-lived, I disabled the passphrase to reduce the number of possible failure points, thus making the `ssh-agent` not required.
  Further, I switched from using `ProxyCommand` to `ProxyJump`, via the `SSH proxy command` and `SSH proxy jump` options, respectively.
  As the `ProxyJump` directive was added to OpenSSH in version 7.3 of, if the machine runs an older version, `ProxyCommand` is required, otherwise, `ProxyJump` is the recommended way.
[^4]: Executed on the OS via a Python `os.system` call.
