---
blogpost: true
category: Blog
tags: SSH, debug
author: Virginie de Mestral
date: 2025-04-04
---

# Debugging a failing SSH connection to a remote computer
<!-- (and bring peace back to the land of AiiDA) -->

## Setting the stage

Recently, I configured a new remote host in the land of AiiDA, a supercomputer going by the name of [Alps](https://www.cscs.ch/computers/alps).
Although Alps is known to be quite powerful, it is also very fond of security.
To be precise, it requires every user who demands its services to validate their ssh key every 24 hours.
Unfortunately, if a user's job lasts longer than those 24 hours, they have to re-validate their key and, if needed, re-`play` their simulation job (`play` meaning re-submit a paused job, in AiiDA jargon).
Thanks to AiiDA's provenance tracking and checkpointing, re-playing a job usually goes smoothly — past information is preserved and passed on to the next calculation.
However, it can happen that the key re-validation process fails, in which case, the initial calculation is indefinitely put on hold.
This can occur (and did so for me), in spite of following exactly the same procedure than for the initial key validation.

## The rising action

I validated my key to access Alps the other day and sent a routine job.
Everything was working fine until the 24h expired.
I then re-validated my key — business as usual, but it had become impossible to reconnect to Alps.
The `verdi computer test alps` command prompted the following message:

```
Error: paramiko.ssh_exception.SSHException: key cannot be used for signing
Error:
Error: Error connecting to 'daint.alps.cscs.ch' through SSH: [SshTransport] No existing session, connect_args were: {'username': 'iam', 'port': 22, 'look_for_keys': True, 'key_filename': '', 'timeout': 60, 'allow_agent': True, 'proxy_jump': '', 'proxy_command': 'ssh -i ~/.ssh/cscs-key iam@ela.cscs.ch /usr/bin/netcat daint.alps.cscs.ch 22', 'compress': True, 'gss_auth': False, 'gss_kex': False, 'gss_deleg_creds': False, 'gss_host': 'daint.alps.cscs.ch'}
[FAILED]: Error while trying to connect to the computer
```
Apparently, AiiDA could not find the right key upon re-validation anymore.
So what happened?

## The climax

Not knowing the exact origin of the problem, one evident attempt was to explicitely tell AiiDA where to find the key.
It might have been looking for the right one among others (yes, I have a conservative tendency to accumulate ssh keys) and picked the wrong one (no offense AiiDA, everybody can make mistakes).
In practice, I needed to make sure that the computer configuration describes the full path to the ssh key, and instead of the `SSH proxy command` give the `SSH proxy jump` computer address.
Also, I set the `Allow ssh agent` and the `Look for keys` options to False.

```
$ verdi computer configure core.ssh alps
Report: enter ? for help.
Report: enter ! to ignore the default and set no value.
User name [iam]:
Port number [22]:
Look for keys [Y/n]: n
SSH key file [/user/.ssh/key]: /home/iam/.ssh/cscs-key
Connection timeout in s [60]:
Allow ssh agent [Y/n]: n
SSH proxy jump []: ela.cscs.ch
SSH proxy command []:
Compress file transfers [Y/n]:
GSS auth [False]:
GSS kex [False]:
GSS deleg_creds [False]:
GSS host [daint.alps.cscs.ch]:
Load system host keys [Y/n]:
Key policy (RejectPolicy, WarningPolicy, AutoAddPolicy) [RejectPolicy]:
Use login shell when executing command [Y/n]:
Connection cooldown time (s) [30.0]:
Report: Configuring computer daint.alps for user aiida@localhost.
Success: alps successfully configured for aiida@localhost
```
This time, the `verdi computer test alps` confirmed that the remote host Alps was successfully configured.

## The falling action

We shall not shout victory too soon, though...
Thanks to the reconfiguration of the remote host, I could send jobs to Alps and retrieve calculations after completion.
However, I still could not access individual jobs while they were running:

```
(aiida) [iam@local ~/.aiida]$ verdi calcjob gotocomputer <pk>
Report: going to the remote work directory...
iam@ela.cscs.ch: Permission denied (publickey).
kex_exchange_identification: Connection closed by remote host
```
The error message issued by AiiDA was very strange. I was able to ssh into alps via the proxy ela outside of AiiDA without any problem, but doing so within the AiiDA machinery informed me that I was denied permission.

## The resolution

In fact, the `gotocomputer` command calls regular ssh protocol, which is defined in the ~/.ssh/config file. Mine read:
```
Host ela
  Hostname ela.cscs.ch
  User vdemestr
  IdentityFile ~/.ssh/cscs-key

Host alps
  Hostname daint.alps.cscs.ch
  User vdemestr
  Proxyjump ela
  Forwardagent yes
  IdentityFile ~/.ssh/cscs-key
  AddKeysToAgent yes
```
Which was confusing to AiiDA. Instead, the ela host should be explicitely designated as `ela.cscs.ch` in the header, and the alps proxyjump variable should read `ela.cscs.ch`:
```
Host ela, ela.cscs.ch
  Hostname ela.cscs.ch
  User vdemestr
  IdentityFile ~/.ssh/cscs-key

Host alps
  Hostname daint.alps.cscs.ch
  User vdemestr
  Proxyjump ela.cscs.ch
  Forwardagent yes
  IdentityFile ~/.ssh/cscs-key
  AddKeysToAgent yes
```

## The denouement

Since then, jobs run smoothly on alps, and can be regularly checked while running using the `verdi calcjob gotocomputer <pk>` command.
Peace has returned to the land of AiiDA.
